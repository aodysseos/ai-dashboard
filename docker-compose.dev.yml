services:
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
      target: development
    container_name: ai-dashboard-api-dev
    ports:
      - "3001:3001"
    volumes:
      # Mount source code for hot-reloading
      - ./apps/api/src:/app/apps/api/src
      - ./packages:/app/packages
      # Use named volumes for node_modules to avoid conflicts
      - api_node_modules:/app/node_modules
      - api_app_node_modules:/app/apps/api/node_modules
    environment:
      - NODE_ENV=development
      - API_PORT=3001
      - API_HOST=0.0.0.0
      - CLIENT_URL=http://localhost:5173
      # S3 Upload Configuration
      - S3_UPLOAD_EXPIRATION=${S3_UPLOAD_EXPIRATION:-300}
      - S3_PUBLIC_ENDPOINT=http://localhost:9000
      # Note: Minio is used automatically in development (no AWS credentials needed)
    env_file:
      - ./apps/api/.env
    networks:
      - ai-dashboard-network
    depends_on:
      minio:
        condition: service_healthy
    restart: unless-stopped

  client:
    build:
      context: .
      dockerfile: apps/client/Dockerfile
      target: development
    container_name: ai-dashboard-client-dev
    ports:
      - "5173:5173"
    volumes:
      # Mount source code for hot-reloading
      - ./apps/client/src:/app/apps/client/src
      - ./apps/client/index.html:/app/apps/client/index.html
      - ./apps/client/vite.config.ts:/app/apps/client/vite.config.ts
      - ./apps/client/tailwind.config.js:/app/apps/client/tailwind.config.js
      - ./apps/client/postcss.config.js:/app/apps/client/postcss.config.js
      - ./packages:/app/packages
      # Use named volumes for node_modules to avoid conflicts
      - client_node_modules:/app/node_modules
      - client_app_node_modules:/app/apps/client/node_modules
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:3001
      - VITE_APP_NAME=AI Dashboard
    env_file:
      - ./apps/client/.env
    networks:
      - ai-dashboard-network
    depends_on:
      - api
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    container_name: ai-dashboard-minio
    ports:
      - "9000:9000"  # API port
      - "9001:9001"  # Console port
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
      # CORS configuration for browser uploads
      - MINIO_API_CORS_ALLOW_ORIGIN=*
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - ai-dashboard-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  minio-init:
    image: minio/mc:latest
    container_name: ai-dashboard-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for Minio to be ready...';
      sleep 5;
      /usr/bin/mc alias set myminio http://minio:9000 minioadmin minioadmin;
      if /usr/bin/mc ls myminio/ai-dashboard-dev > /dev/null 2>&1; then
        echo 'Bucket ai-dashboard-dev already exists';
      else
        echo 'Creating bucket ai-dashboard-dev...';
        /usr/bin/mc mb myminio/ai-dashboard-dev;
        echo 'Bucket created successfully';
      fi;
      echo 'Minio initialization complete';
      exit 0;
      "
    networks:
      - ai-dashboard-network

networks:
  ai-dashboard-network:
    driver: bridge

volumes:
  api_node_modules:
  api_app_node_modules:
  client_node_modules:
  client_app_node_modules:
  minio_data:

